#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <dev|dev1|dev2>"
  exit 1
fi

TARGET="$1"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Find the workflow file: dev*.yml or dev*.yaml
WORKFLOW_FILE=$(ls .github/workflows/${TARGET}-*.yml 2>/dev/null || true)
if [[ -z "$WORKFLOW_FILE" ]]; then
  WORKFLOW_FILE=$(ls .github/workflows/${TARGET}-*.yaml 2>/dev/null || true)
fi

if [[ -z "$WORKFLOW_FILE" ]]; then
  echo "❌ No workflow file found for: $TARGET"
  exit 1
fi

echo "Found workflow: $WORKFLOW_FILE"
echo "Updating branch → $CURRENT_BRANCH"

# Replace with yq
yq -i "
  .on.push.branches = [\"$CURRENT_BRANCH\"]
" "$WORKFLOW_FILE"

echo "✅ Workflow updated"

# git add + commit + push
git add "$WORKFLOW_FILE"

COMMIT_MSG="ci: trigger ${TARGET}"
echo "Committing: $COMMIT_MSG"

git commit -m "$COMMIT_MSG"

echo "Pushing branch: $CURRENT_BRANCH"
git push origin "$CURRENT_BRANCH"

echo "✅ Pushed successfully"
